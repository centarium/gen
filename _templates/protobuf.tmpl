syntax = "proto3";

package {{.protoGoPackage}};
{{ if .TablesMetaInfo.HaveValidations -}}
import "validate/validate.proto";
{{end}}

option go_package = "/{{.protoGoPackage}}";

message Result {
    enum result_type {
        Error = 0;
        Success = 1;
    }

    result_type code = 1;
    string message = 2;
}

service Backend {
{{ range $tableName, $tableInfo := .tableInfos }}
    rpc GetAll{{ $tableInfo.StructName }}(GetAll{{ $tableInfo.StructName }}Request) returns (GetAll{{ $tableInfo.StructName }}Response);
    rpc Get{{ $tableInfo.StructName }}(Get{{ $tableInfo.StructName }}Request) returns (Get{{ $tableInfo.StructName }}Response);
    rpc Add{{ $tableInfo.StructName }}(Add{{ $tableInfo.StructName }}Request) returns (Add{{ $tableInfo.StructName }}Response);
    rpc Update{{ $tableInfo.StructName }}(Update{{ $tableInfo.StructName }}Request) returns (Update{{ $tableInfo.StructName }}Response);
    rpc Delete{{ $tableInfo.StructName }}(Delete{{ $tableInfo.StructName }}Request) returns (Delete{{ $tableInfo.StructName }}Response);
{{- end}}
}

{{ range $tableName, $tableInfo := .tableInfos }}
// table: {{$tableName}}
message {{ $tableInfo.StructName }} {
{{- range $i, $field := $tableInfo.CodeFields -}}
      {{ $validation := "" -}}
      {{ if $field.ColumnMeta.IsNumberNonZero -}}
        {{ $validation = printf "[(validate.rules).%s.gt = 0]" $field.ProtobufType -}}
      {{ else if $field.ColumnMeta.IsStringNonZero -}}
        {{ $validation = "[(validate.rules).string.min_len = 1]" -}}
      {{- end }}
    {{ $field.ProtobufType}} {{ $field.ProtobufFieldName}} = {{  $field.ProtobufPos}}{{ $validation }};
{{- end}}
}

message GetAll{{ $tableInfo.StructName }}Request {
    int64 page = 1;
    int64 page_size = 2;
    string order = 3;
}

message GetAll{{ $tableInfo.StructName }}Response {
    Result result = 1;
    repeated {{$tableInfo.StructName}} data = 2;
    int64 page = 3;
    int64 page_size = 4;
    int64 total_records = 5;
}


message Get{{ $tableInfo.StructName }}Request {
{{- $fieldPos := set 0 -}}{{ range $i, $field := $tableInfo.CodeFields }}{{ if $field.ColumnMeta.IsPrimaryKey }}{{ $fieldPos := inc}}
    {{ $field.ProtobufType}} {{ $field.ProtobufFieldName}} = {{ $fieldPos}};{{- end }}{{- end}}
}

message Get{{ $tableInfo.StructName }}Response {
    Result result = 1;
    {{$tableInfo.StructName}} data = 2;
}
message Add{{ $tableInfo.StructName }}Request {
    {{$tableInfo.StructName}} data = 1;
}

message Add{{ $tableInfo.StructName }}Response {
    Result result = 1;
    {{$tableInfo.StructName}} data = 2;
    int64 rowsAffected = 3;
}

message Update{{ $tableInfo.StructName }}Request {
    {{$tableInfo.StructName}} data = 1;
}

message Update{{ $tableInfo.StructName }}Response {
    Result result = 1;
    {{$tableInfo.StructName}} data = 2;
    int64 rowsAffected = 3;
}

message Delete{{ $tableInfo.StructName }}Request {
{{- $fieldPos := set 0 -}}{{ range $i, $field := $tableInfo.CodeFields }}{{ if $field.ColumnMeta.IsPrimaryKey }}{{ $fieldPos := inc }}
    {{ $field.ProtobufType}} {{ $field.ProtobufFieldName}} = {{ $fieldPos}};{{- end }}{{- end}}
}

message Delete{{ $tableInfo.StructName }}Response {
    Result result = 1;
    int64 rows_affected = 2;
}

{{ end}}